<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edge Scanner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>Edge Scanner</h1>
                <div class="subtitle">Arbitrage • Middles • +EV</div>
            </div>
            <div class="toggle-group">
                <div class="toggle-btn active" id="odds-decimal">Decimal</div>
                <div class="toggle-btn" id="odds-american" style="color: #64748b;">American</div>
            </div>
        </div>

        <form id="scanner-form">
            <div class="main-panel">
                <div class="form-section">
                    <div>
                        <label>API KEY</label>
                        <div class="api-success">
                            <span>✓</span> Using API key from .env
                        </div>
                    </div>
                    <div>
                        <label>TOTAL STAKE ($)</label>
                        <input type="number" name="stake" value="{{ default_bankroll }}">
                        <div class="subtitle" style="font-size: 12px; margin-top: 5px;">Used for arbitrage + middles stake splits.</div>
                    </div>
                </div>

                <div class="form-section">
                    <label>SPORTS</label>
                    <div class="checkbox-grid">
                        {% for sport in default_sports %}
                        <label class="checkbox-item">
                            <input type="checkbox" name="sports" value="{{ sport.key }}" checked> {{ sport.title }}
                        </label>
                        {% endfor %}
                    </div>
                    <div style="margin-top: 10px;">
                        <label class="checkbox-item" style="color: white;">
                            <input type="checkbox" name="allSports"> Scan all active sports (uses more API credits)
                        </label>
                    </div>
                </div>

                <div class="form-section">
                    <label>REGIONS</label>
                    <div class="checkbox-grid">
                        {% for region in region_options %}
                        <label class="checkbox-item">
                            <input type="checkbox" name="regions" value="{{ region.key }}" checked> {{ region.title }}
                        </label>
                        {% endfor %}
                    </div>
                    <div style="background: #253045; padding: 15px; border-radius: 8px; border: 1px solid #334155; margin-top: 15px;">
                        <label>EXCHANGE COMMISSION (%)</label>
                        <input type="number" name="commission" value="{{ default_commission_percent }}">
                    </div>
                </div>
            </div>

            <button type="submit" class="scan-btn" id="scan-btn">Scan Now</button>
        </form>

        <div class="results-wrapper" id="results-wrapper" style="display: none; margin-top: 30px;">
            <div class="tabs">
                <div class="tab active" data-tab="arbitrage">Arbitrage</div>
                <div class="tab" data-tab="middles">Middles</div>
                <div class="tab" data-tab="plus-ev">+EV</div>
            </div>

            <div class="tab-content active" id="arbitrage">
                <table id="table-arbitrage">
                    <thead><tr><th>Sport</th><th>Event</th><th>Market</th><th>ROI</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="tab-content" id="middles">
                <table id="table-middles">
                    <thead><tr><th>Sport</th><th>Event</th><th>Middle Range</th><th>ROI</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="tab-content" id="plus-ev">
                <table id="table-plus-ev">
                    <thead><tr><th>Sport</th><th>Event</th><th>Edge</th><th>ROI</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Lógica de Troca de Abas
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Lógica do Scan (Fix para não abrir página branca)
        document.getElementById('scanner-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('scan-btn');
            btn.innerText = 'Scanning...';
            btn.disabled = true;

            const formData = new FormData(e.target);
            const payload = {
                sports: formData.getAll('sports'),
                regions: formData.getAll('regions'),
                stake: formData.get('stake'),
                commission: formData.get('commission'),
                allSports: formData.get('allSports') === 'on'
            };

            try {
                const response = await fetch('/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                
                document.getElementById('results-wrapper').style.display = 'block';
                
                // Preencher Arbitragem
                renderTable('table-arbitrage', data.arbitrage?.opportunities || []);
                // Preencher Middles
                renderTable('table-middles', data.middles?.opportunities || []);
                // Preencher +EV
                renderTable('table-plus-ev', data.plus_ev?.opportunities || []);

            } catch (err) {
                alert("Erro ao processar dados. Verifique os logs.");
            } finally {
                btn.innerText = 'Scan Now';
                btn.disabled = false;
            }
        });

        function renderTable(id, items) {
            const tbody = document.querySelector(`#${id} tbody`);
            tbody.innerHTML = items.length ? '' : '<tr><td colspan="4">No opportunities found.</td></tr>';
            items.forEach(item => {
                tbody.innerHTML += `
                    <tr>
                        <td>${item.sport}</td>
                        <td>${item.event}</td>
                        <td>${item.market || item.range || '-'}</td>
                        <td><span class="roi-badge">${item.roi_percent}%</span></td>
                    </tr>`;
            });
        }
    </script>
</body>
</html>
