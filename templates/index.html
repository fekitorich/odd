<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Edge Scanner - MODO DIAGN√ìSTICO</title>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --text: #e2e8f0; --primary: #3b82f6; --green: #064e3b; --red: #7f1d1d; }
        body { background: var(--bg); color: var(--text); font-family: monospace; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .panel { background: var(--panel); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #334155; }
        
        /* Bot√µes */
        .btn { padding: 15px; width: 100%; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .btn-scan { background: var(--primary); color: white; }
        .btn-scan:hover { background: #2563eb; }
        .btn-debug { background: #000; color: #0f0; border: 1px solid #0f0; margin-top: 20px; font-family: monospace; }

        /* Tabela */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 10px; background: rgba(0,0,0,0.3); color: #94a3b8; }
        td { padding: 10px; border-bottom: 1px solid #334155; vertical-align: top; }
        
        /* Debug Area */
        #raw-json { 
            display: none; 
            white-space: pre-wrap; 
            background: #000; 
            color: #0f0; 
            padding: 20px; 
            border-radius: 8px; 
            font-size: 11px; 
            border: 1px solid #333;
            max-height: 500px;
            overflow-y: scroll;
        }

        .tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-right: 5px; }
        .tag-market { background: #334155; color: #60a5fa; }
        .tag-bookie { background: #334155; color: #fbbf24; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color: white;">SCANNER DIAGN√ìSTICO</h2>
    
    <form id="form" class="panel">
        <label>API KEY</label>
        <input type="text" name="apiKey" value="ac611e223968599cffdcd6c1944f9958" style="width:100%; padding:8px; margin-bottom:10px; background:#0f172a; border:1px solid #334155; color:white;">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div>
                <label style="color:#94a3b8; font-size:12px;">LIGAS</label><br>
                <label><input type="checkbox" name="sports" value="basketball_nba" checked> NBA</label><br>
                <label><input type="checkbox" name="sports" value="soccer_brazil_campeonato" checked> Brasil S√©rie A</label><br>
                <label><input type="checkbox" name="sports" value="americanfootball_nfl"> NFL</label>
            </div>
            <div>
                <label style="color:#94a3b8; font-size:12px;">REGI√ïES</label><br>
                <label><input type="checkbox" name="regions" value="eu" checked> EU (Pinnacle)</label>
                <label><input type="checkbox" name="regions" value="uk" checked> UK (Betfair)</label>
            </div>
        </div>

        <button type="submit" id="btn" class="btn btn-scan">SCAN NOW (Buscar Tudo)</button>
    </form>

    <div id="results" class="panel" style="display:none;">
        <h3 style="margin:0 0 15px 0;">Resultados Encontrados</h3>
        <table>
            <thead>
                <tr>
                    <th>Jogo / Liga</th>
                    <th>Aposta (Tentativa de Leitura)</th>
                    <th>Lucro (%)</th>
                </tr>
            </thead>
            <tbody id="tb-body"></tbody>
        </table>
    </div>

    <button onclick="toggleDebug()" class="btn btn-debug">üõ†Ô∏è ABRIR DADOS BRUTOS (JSON)</button>
    <div id="raw-json">Clique no bot√£o acima ap√≥s o scan para ver o que a API mandou.</div>
</div>

<script>
    let lastData = null;

    function toggleDebug() {
        const div = document.getElementById('raw-json');
        div.style.display = div.style.display === 'block' ? 'none' : 'block';
        if(lastData) div.textContent = JSON.stringify(lastData, null, 2);
    }

    document.getElementById('form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btn');
        const tbody = document.getElementById('tb-body');
        const results = document.getElementById('results');
        
        btn.innerText = 'Processando...';
        btn.disabled = true;
        tbody.innerHTML = '';

        try {
            const formData = new FormData(e.target);
            const payload = {
                apiKey: formData.get('apiKey'),
                sports: [...formData.getAll('sports')],
                regions: [...formData.getAll('regions')],
                stake: 100
            };

            const res = await fetch('/scan', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            lastData = data; // Salva para o debug

            results.style.display = 'block';

            // Junta tudo (+EV e Arbitragem) em uma lista s√≥ para testar
            let allOps = [];
            if(data.plus_ev?.opportunities) allOps = allOps.concat(data.plus_ev.opportunities);
            if(data.arbitrage?.opportunities) allOps = allOps.concat(data.arbitrage.opportunities);

            if (allOps.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">NENHUM DADO RETORNADO PELA API.<br>Verifique se tem saldo ou se as ligas tem jogos hoje.</td></tr>';
            } else {
                allOps.forEach(item => {
                    // TENTATIVA DE LEITURA √Ä PROVA DE FALHAS
                    const sport = item.sport || item.sport_key || 'N/A';
                    const event = item.event || item.match || 'N/A';
                    const roi = item.edge_percent || item.roi || item.profit || 0;
                    
                    // Constr√≥i a aposta varrendo tudo
                    let betHTML = '';
                    
                    // Se tiver lista de outcomes
                    if (item.outcomes && item.outcomes.length) {
                        item.outcomes.forEach(oc => {
                            // Procura qualquer chave que pare√ßa uma odd ou nome
                            const name = oc.name || oc.selection || 'Sel?';
                            const book = oc.bookmaker || oc.bookie || 'Casa?';
                            const price = oc.price || oc.odds || oc.decimal || 'Odd?';
                            const point = oc.point || item.point || ''; // Linha (Over 2.5)
                            
                            betHTML += `<div style="margin-bottom:5px;">
                                <span class="tag tag-market">${item.market || 'Mkt'}</span>
                                <b>${name} ${point}</b> na <span class="tag tag-bookie">${book}</span> @ <b>${price}</b>
                            </div>`;
                        });
                    } 
                    // Se for objeto simples
                    else {
                        const name = item.selection || item.name || 'Sel?';
                        const book = item.bookmaker || item.bookie || 'Casa?';
                        const price = item.price || item.odds || 'Odd?';
                        const point = item.point ? `(${item.point})` : '';
                        
                        betHTML = `<div>
                            <span class="tag tag-market">${item.market || 'Mkt'}</span>
                            <b>${name} ${point}</b> na <span class="tag tag-bookie">${book}</span> @ <b>${price}</b>
                        </div>`;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td><b>${sport}</b><br><small>${event}</small></td>
                            <td>${betHTML}</td>
                            <td style="color:${roi > 0 ? '#34d399' : '#f87171'}; font-weight:bold;">${parseFloat(roi).toFixed(2)}%</td>
                        </tr>
                    `;
                });
            }

        } catch (err) {
            alert('ERRO T√âCNICO: ' + err.message);
        } finally {
            btn.innerText = 'SCAN NOW';
            btn.disabled = false;
        }
    });
</script>

</body>
</html>
